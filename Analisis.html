<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis Estad√≠stico de Producci√≥n de Banano</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/11.7.32/sweetalert2.all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M30,10 Q50,0 70,10 Q90,20 90,40 Q90,60 70,70 Q50,80 30,70 Q10,60 10,40 Q10,20 30,10" fill="%23f9d423"/></svg>');
            background-size: 100px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9rem;
        }

        select, input {
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #FFC107, #FF9800);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-small {
            height: 300px;
        }

        .data-table {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #4CAF50;
            font-size: 1.2rem;
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        .banana-icon {
            color: #FFC107;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header animate-fade-in">
            <h1><span class="banana-icon">üçå</span> An√°lisis de Producci√≥n de Banano</h1>
            <p>Visualizaci√≥n del rendimiento hist√≥rico del cultivo de banano y detecci√≥n de patrones</p>
            
            <div class="controls">
                <div class="control-group">
                    <label>A√±o:</label>
                    <select id="yearFilter">
                        <option value="all">Todos los a√±os</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Finca:</label>
                    <select id="fincaFilter">
                        <option value="all">Todas las fincas</option>
                        <option value="norte">Finca Norte</option>
                        <option value="sur">Finca Sur</option>
                        <option value="este">Finca Este</option>
                        <option value="oeste">Finca Oeste</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Tipo de Banano:</label>
                    <select id="tipoBananoFilter">
                        <option value="all">Todos los tipos</option>
                        <option value="dortio">Dortio</option>
                        <option value="gros_michel">Gros Michel</option>
                        <option value="cavendish">Cavendish</option>
                    </select>
                </div>
            </div>

            <div class="export-buttons">
                <button class="btn btn-primary" onclick="exportToPDF()">üìÑ Exportar PDF</button>
                <button class="btn btn-secondary" onclick="exportToExcel()">üìä Exportar Excel</button>
            </div>
        </div>

        <div class="metrics-grid animate-fade-in">
            <div class="metric-card">
                <div class="metric-value" id="totalProduction">0</div>
                <div class="metric-label">Racimos Totales</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="avgYield">0</div>
                <div class="metric-label">Racimos/Hect√°rea</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="exportPercent">0%</div>
                <div class="metric-label">% Exportado</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalFarms">0</div>
                <div class="metric-label">Fincas Activas</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card animate-fade-in">
                <h3>üìä Producci√≥n Mensual</h3>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <div class="card animate-fade-in">
                <h3>üìà Comparativa por A√±os</h3>
                <div class="chart-container">
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>

            <div class="card animate-fade-in">
                <h3>üè¢ Producci√≥n por Fincas</h3>
                <div class="chart-container chart-small">
                    <canvas id="farmsChart"></canvas>
                </div>
            </div>

            <div class="card animate-fade-in">
                <h3>üçå Distribuci√≥n por Tipo</h3>
                <div class="chart-container chart-small">
                    <canvas id="typesChart"></canvas>
                </div>
            </div>

            <div class="card animate-fade-in">
                <h3>üì§ Exportaci√≥n vs Nacional</h3>
                <div class="chart-container chart-small">
                    <canvas id="exportChart"></canvas>
                </div>
            </div>

            <div class="card animate-fade-in">
                <h3>üí∞ Rendimiento por Hect√°rea</h3>
                <div class="chart-container">
                    <canvas id="yieldChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card animate-fade-in">
            <h3>üìã Tabla de Datos Detallados</h3>
            <div class="data-table">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>A√±o</th>
                            <th>Finca</th>
                            <th>Tipo Banano</th>
                            <th>Producci√≥n (Racimos)</th>
                            <th>Hect√°reas</th>
                            <th>Rac/Hect√°rea</th>
                            <th>Exportado (%)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="loading" id="loading">
            <p>‚è≥ Procesando datos...</p>
        </div>
    </div>

    <script>
        // Datos simulados de producci√≥n de banano
        const productionData = [
            { month: 'Enero', year: 2024, finca: 'norte', tipoBanano: 'dortio', production: 8500, hectares: 30, exported: 80 },
            { month: 'Febrero', year: 2024, finca: 'sur', tipoBanano: 'gros_michel', production: 9200, hectares: 35, exported: 85 },
            { month: 'Marzo', year: 2024, finca: 'este', tipoBanano: 'cavendish', production: 7800, hectares: 28, exported: 75 },
            { month: 'Abril', year: 2024, finca: 'oeste', tipoBanano: 'dortio', production: 10500, hectares: 40, exported: 90 },
            { month: 'Mayo', year: 2024, finca: 'norte', tipoBanano: 'gros_michel', production: 11500, hectares: 38, exported: 82 },
            { month: 'Junio', year: 2024, finca: 'sur', tipoBanano: 'cavendish', production: 9800, hectares: 36, exported: 88 },
            { month: 'Julio', year: 2024, finca: 'este', tipoBanano: 'dortio', production: 8200, hectares: 32, exported: 78 },
            { month: 'Agosto', year: 2024, finca: 'oeste', tipoBanano: 'gros_michel', production: 12500, hectares: 45, exported: 92 },
            { month: 'Septiembre', year: 2024, finca: 'norte', tipoBanano: 'cavendish', production: 11000, hectares: 37, exported: 80 },
            { month: 'Octubre', year: 2024, finca: 'sur', tipoBanano: 'dortio', production: 9500, hectares: 34, exported: 84 },
            { month: 'Noviembre', year: 2024, finca: 'este', tipoBanano: 'gros_michel', production: 8000, hectares: 30, exported: 76 },
            { month: 'Diciembre', year: 2024, finca: 'oeste', tipoBanano: 'cavendish', production: 11800, hectares: 42, exported: 90 },
            
            // Datos 2023
            { month: 'Enero', year: 2023, finca: 'norte', tipoBanano: 'dortio', production: 8000, hectares: 29, exported: 78 },
            { month: 'Febrero', year: 2023, finca: 'sur', tipoBanano: 'gros_michel', production: 8800, hectares: 33, exported: 82 },
            { month: 'Marzo', year: 2023, finca: 'este', tipoBanano: 'cavendish', production: 7500, hectares: 27, exported: 72 },
            { month: 'Abril', year: 2023, finca: 'oeste', tipoBanano: 'dortio', production: 9800, hectares: 38, exported: 87 },
            { month: 'Mayo', year: 2023, finca: 'norte', tipoBanano: 'gros_michel', production: 10800, hectares: 36, exported: 80 },
            { month: 'Junio', year: 2023, finca: 'sur', tipoBanano: 'cavendish', production: 9200, hectares: 34, exported: 85 },
            { month: 'Julio', year: 2023, finca: 'este', tipoBanano: 'dortio', production: 7800, hectares: 30, exported: 75 },
            { month: 'Agosto', year: 2023, finca: 'oeste', tipoBanano: 'gros_michel', production: 11800, hectares: 42, exported: 90 },
            { month: 'Septiembre', year: 2023, finca: 'norte', tipoBanano: 'cavendish', production: 10500, hectares: 35, exported: 78 },
            { month: 'Octubre', year: 2023, finca: 'sur', tipoBanano: 'dortio', production: 9000, hectares: 32, exported: 82 },
            { month: 'Noviembre', year: 2023, finca: 'este', tipoBanano: 'gros_michel', production: 7700, hectares: 29, exported: 73 },
            { month: 'Diciembre', year: 2023, finca: 'oeste', tipoBanano: 'cavendish', production: 11200, hectares: 40, exported: 88 }
        ];

        let charts = {};

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar bienvenida con SweetAlert
            Swal.fire({
                title: 'üçå ¬°Bienvenido al Sistema de Banano!',
                html: 
                    `<div style="text-align: left; margin: 20px 0;">
                        <p>üìà <strong>Visualiza</strong> el rendimiento de tus cultivos de banano</p>
                        <p>üìä <strong>Analiza</strong> tendencias por tipo de banano</p>
                        <p>üì§ <strong>Exporta</strong> reportes en PDF y Excel</p>
                        <p>üîç <strong>Filtra</strong> por a√±o, finca y tipo de banano</p>
                    </div>`,
                imageUrl: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%234CAF50"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="40">üçå</text></svg>',
                imageWidth: 100,
                imageHeight: 100,
                confirmButtonText: '¬°Empezar An√°lisis!',
                confirmButtonColor: '#4CAF50',
                showClass: {
                    popup: 'animate__animated animate__fadeInDown'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOutUp'
                }
            }).then(() => {
                initializeCharts();
                updateDashboard();
                setupEventListeners();
            });
        });

        function setupEventListeners() {
            document.getElementById('yearFilter').addEventListener('change', updateDashboard);
            document.getElementById('fincaFilter').addEventListener('change', updateDashboard);
            document.getElementById('tipoBananoFilter').addEventListener('change', updateDashboard);
        }

        function getFilteredData() {
            const yearFilter = document.getElementById('yearFilter').value;
            const fincaFilter = document.getElementById('fincaFilter').value;
            const tipoBananoFilter = document.getElementById('tipoBananoFilter').value;

            return productionData.filter(item => {
                return (yearFilter === 'all' || item.year.toString() === yearFilter) &&
                       (fincaFilter === 'all' || item.finca === fincaFilter) &&
                       (tipoBananoFilter === 'all' || item.tipoBanano === tipoBananoFilter);
            });
        }

        function updateMetrics() {
            const data = getFilteredData();
            
            const totalProduction = data.reduce((sum, item) => sum + item.production, 0);
            const totalHectares = data.reduce((sum, item) => sum + item.hectares, 0);
            const avgYield = totalHectares > 0 ? Math.round(totalProduction / totalHectares) : 0;
            const avgExported = data.length > 0 ? Math.round(data.reduce((sum, item) => sum + item.exported, 0) / data.length) : 0;
            const totalFarms = new Set(data.map(item => item.finca)).size;

            document.getElementById('totalProduction').textContent = totalProduction.toLocaleString();
            document.getElementById('avgYield').textContent = avgYield.toLocaleString();
            document.getElementById('exportPercent').textContent = avgExported + '%';
            document.getElementById('totalFarms').textContent = totalFarms;
        }

        function initializeCharts() {
            // Gr√°fico de producci√≥n mensual
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Producci√≥n (Racimos)',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' rac';
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fico comparativo por a√±os
            const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
            charts.yearly = new Chart(yearlyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Producci√≥n Total (Racimos)',
                        data: [],
                        backgroundColor: 'rgba(76, 175, 80, 0.8)',
                        borderColor: '#4CAF50',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' rac';
                                }
                            }
                        }
                    }
                }
            });

            // Gr√°fico por fincas
            const farmsCtx = document.getElementById('farmsChart').getContext('2d');
            charts.farms = new Chart(farmsCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#4CAF50',
                            '#8BC34A',
                            '#CDDC39',
                            '#FFC107'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gr√°fico por tipos de banano
            const typesCtx = document.getElementById('typesChart').getContext('2d');
            charts.types = new Chart(typesCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#4CAF50',
                            '#FFC107',
                            '#FF9800'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gr√°fico exportaci√≥n vs nacional
            const exportCtx = document.getElementById('exportChart').getContext('2d');
            charts.export = new Chart(exportCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Exportado', 'Nacional'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#4CAF50', '#FF9800']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gr√°fico rendimiento por hect√°rea
            const yieldCtx = document.getElementById('yieldChart').getContext('2d');
            charts.yield = new Chart(yieldCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Racimos/Hect√°rea',
                        data: [],
                        backgroundColor: 'rgba(139, 195, 74, 0.8)',
                        borderColor: '#8BC34A',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' rac/ha';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateDashboard() {
            // Mostrar alerta de carga con SweetAlert
            Swal.fire({
                title: 'üìä Actualizando Dashboard',
                text: 'Procesando datos y actualizando gr√°ficos...',
                icon: 'info',
                allowOutsideClick: false,
                showConfirmButton: false,
                timer: 800,
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                }
            }).then(() => {
                const data = getFilteredData();
                
                updateMetrics();
                updateMonthlyChart(data);
                updateYearlyChart(data);
                updateFarmsChart(data);
                updateTypesChart(data);
                updateExportChart(data);
                updateYieldChart(data);
                updateTable(data);
                
                // Mostrar notificaci√≥n de √©xito
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });

                Toast.fire({
                    icon: 'success',
                    title: '‚úÖ Dashboard actualizado correctamente'
                });
            });
        }

        function updateMonthlyChart(data) {
            const monthlyData = data.reduce((acc, item) => {
                const key = `${item.month} ${item.year}`;
                if (!acc[key]) acc[key] = 0;
                acc[key] += item.production;
                return acc;
            }, {});

            charts.monthly.data.labels = Object.keys(monthlyData);
            charts.monthly.data.datasets[0].data = Object.values(monthlyData);
            charts.monthly.update();
        }

        function updateYearlyChart(data) {
            const yearlyData = data.reduce((acc, item) => {
                if (!acc[item.year]) acc[item.year] = 0;
                acc[item.year] += item.production;
                return acc;
            }, {});

            charts.yearly.data.labels = Object.keys(yearlyData);
            charts.yearly.data.datasets[0].data = Object.values(yearlyData);
            charts.yearly.update();
        }

        function updateFarmsChart(data) {
            const farmsData = data.reduce((acc, item) => {
                const fincaName = item.finca.charAt(0).toUpperCase() + item.finca.slice(1);
                if (!acc[fincaName]) acc[fincaName] = 0;
                acc[fincaName] += item.production;
                return acc;
            }, {});

            charts.farms.data.labels = Object.keys(farmsData);
            charts.farms.data.datasets[0].data = Object.values(farmsData);
            charts.farms.update();
        }

        function updateTypesChart(data) {
            const typesData = data.reduce((acc, item) => {
                let tipoName = '';
                switch(item.tipoBanano) {
                    case 'dortio': tipoName = 'Dortio'; break;
                    case 'gros_michel': tipoName = 'Gros Michel'; break;
                    case 'cavendish': tipoName = 'Cavendish'; break;
                }
                
                if (!acc[tipoName]) acc[tipoName] = 0;
                acc[tipoName] += item.production;
                return acc;
            }, {});

            charts.types.data.labels = Object.keys(typesData);
            charts.types.data.datasets[0].data = Object.values(typesData);
            charts.types.update();
        }

        function updateExportChart(data) {
            const totalProduction = data.reduce((sum, item) => sum + item.production, 0);
            const totalExported = data.reduce((sum, item) => sum + (item.production * item.exported / 100), 0);
            const totalNational = totalProduction - totalExported;

            charts.export.data.datasets[0].data = [totalExported, totalNational];
            charts.export.update();
        }

        function updateYieldChart(data) {
            const yieldData = data.reduce((acc, item) => {
                const key = `${item.finca} - ${getTipoBananoName(item.tipoBanano)}`;
                if (!acc[key]) {
                    acc[key] = { production: 0, hectares: 0 };
                }
                acc[key].production += item.production;
                acc[key].hectares += item.hectares;
                return acc;
            }, {});

            const labels = Object.keys(yieldData);
            const yields = labels.map(key => Math.round(yieldData[key].production / yieldData[key].hectares));

            charts.yield.data.labels = labels;
            charts.yield.data.datasets[0].data = yields;
            charts.yield.update();
        }

        function getTipoBananoName(tipo) {
            switch(tipo) {
                case 'dortio': return 'Dortio';
                case 'gros_michel': return 'Gros Michel';
                case 'cavendish': return 'Cavendish';
                default: return tipo;
            }
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = tbody.insertRow();
                const yield = Math.round(item.production / item.hectares);
                const tipoName = getTipoBananoName(item.tipoBanano);
                
                row.innerHTML = `
                    <td>${item.month}</td>
                    <td>${item.year}</td>
                    <td>${item.finca.charAt(0).toUpperCase() + item.finca.slice(1)}</td>
                    <td>${tipoName}</td>
                    <td>${item.production.toLocaleString()}</td>
                    <td>${item.hectares}</td>
                    <td>${yield.toLocaleString()}</td>
                    <td>${item.exported}%</td>
                `;
            });
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.text('An√°lisis Estad√≠stico de Producci√≥n de Banano', 20, 30);
            
            // Fecha
            doc.setFontSize(12);
            doc.text(`Generado: ${new Date().toLocaleDateString()}`, 20, 45);
            
            // M√©tricas
            const totalProd = document.getElementById('totalProduction').textContent;
            const avgYield = document.getElementById('avgYield').textContent;
            const exportPercent = document.getElementById('exportPercent').textContent;
            const totalFarms = document.getElementById('totalFarms').textContent;
            
            doc.setFontSize(14);
            doc.text('M√©tricas Clave:', 20, 65);
            doc.setFontSize(12);
            doc.text(`‚Ä¢ Producci√≥n Total: ${totalProd} racimos`, 25, 80);
            doc.text(`‚Ä¢ Rendimiento Promedio: ${avgYield} rac/ha`, 25, 95);
            doc.text(`‚Ä¢ Porcentaje Exportado: ${exportPercent}`, 25, 110);
            doc.text(`‚Ä¢ Fincas Activas: ${totalFarms}`, 25, 125);
            
            // Tabla de datos
            const data = getFilteredData();
            let yPos = 150;
            
            doc.setFontSize(14);
            doc.text('Datos Detallados:', 20, yPos);
            yPos += 20;
            
            // Encabezados de tabla
            doc.setFontSize(10);
            doc.text('Mes', 20, yPos);
            doc.text('A√±o', 40, yPos);
            doc.text('Finca', 60, yPos);
            doc.text('Tipo', 85, yPos);
            doc.text('Producci√≥n', 115, yPos);
            doc.text('Ha', 145, yPos);
            doc.text('Rac/Ha', 160, yPos);
            doc.text('Exp%', 180, yPos);
            
            yPos += 10;
            
            // Datos de la tabla
            data.slice(0, 15).forEach(item => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 30;
                }
                
                const yield = Math.round(item.production / item.hectares);
                const tipoName = getTipoBananoName(item.tipoBanano);
                doc.text(item.month.substr(0, 3), 20, yPos);
                doc.text(item.year.toString(), 40, yPos);
                doc.text(item.finca.substr(0, 5), 60, yPos);
                doc.text(tipoName.substr(0, 6), 85, yPos);
                doc.text(item.production.toLocaleString(), 115, yPos);
                doc.text(item.hectares.toString(), 145, yPos);
                doc.text(yield.toLocaleString(), 160, yPos);
                doc.text(`${item.exported}%`, 180, yPos);
                
                yPos += 8;
            });
            
            doc.save('analisis-banano.pdf');
        }

        function exportToExcel() {
            const data = getFilteredData();
            
            // Preparar datos para Excel
            const excelData = data.map(item => ({
                'Mes': item.month,
                'A√±o': item.year,
                'Finca': item.finca.charAt(0).toUpperCase() + item.finca.slice(1),
                'Tipo de Banano': getTipoBananoName(item.tipoBanano),
                'Producci√≥n (Racimos)': item.production,
                'Hect√°reas': item.hectares,
                'Rac/Hect√°rea': Math.round(item.production / item.hectares),
                'Exportado (%)': item.exported
            }));
            
            // Agregar m√©tricas al inicio
            const metrics = [
                { 'Mes': 'M√âTRICAS GENERALES', 'A√±o': '', 'Finca': '', 'Tipo de Banano': '', 'Producci√≥n (Racimos)': '', 'Hect√°reas': '', 'Rac/Hect√°rea': '', 'Exportado (%)': '' },
                { 'Mes': 'Total Producci√≥n', 'A√±o': document.getElementById('totalProduction').textContent + ' racimos', 'Finca': '', 'Tipo de Banano': '', 'Producci√≥n (Racimos)': '', 'Hect√°reas': '', 'Rac/Hect√°rea': '', 'Exportado (%)': '' },
                { 'Mes': 'Rendimiento Promedio', 'A√±o': document.getElementById('avgYield').textContent + ' rac/ha', 'Finca': '', 'Tipo de Banano': '', 'Producci√≥n (Racimos)': '', 'Hect√°reas': '', 'Rac/Hect√°rea': '', 'Exportado (%)': '' },
                { 'Mes': 'Porcentaje Exportado', 'A√±o': document.getElementById('exportPercent').textContent, 'Finca': '', 'Tipo de Banano': '', 'Producci√≥n (Racimos)': '', 'Hect√°reas': '', 'Rac/Hect√°rea': '', 'Exportado (%)': '' },
                { 'Mes': 'Fincas Activas', 'A√±o': document.getElementById('totalFarms').textContent, 'Finca': '', 'Tipo de Banano': '', 'Producci√≥n (Racimos)': '', 'Hect√°reas': '', 'Rac/Hect√°rea': '', 'Exportado (%)': '' },
                { 'Mes': '', 'A√±o': '', 'Finca': '', 'Tipo de Banano': '', 'Producci√≥n (Racimos)': '', 'Hect√°reas': '', 'Rac/Hect√°rea': '', 'Exportado (%)': '' },
                { 'Mes': 'DATOS DETALLADOS', 'A√±o': '', 'Finca': '', 'Tipo de Banano': '', 'Producci√≥n (Racimos)': '', 'Hect√°reas': '', 'Rac/Hect√°rea': '', 'Exportado (%)': '' }
            ];
            
            const finalData = [...metrics, ...excelData];
            
            // Crear workbook
            const ws = XLSX.utils.json_to_sheet(finalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "An√°lisis Banano");
            
            // Guardar archivo
            XLSX.writeFile(wb, 'analisis-banano.xlsx');
        }

        // Animaciones y efectos adicionales
        function addChartAnimations() {
            const cards = document.querySelectorAll('.card');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.animation = 'fadeIn 0.6s ease-in';
                    }
                });
            });

            cards.forEach(card => {
                observer.observe(card);
            });
        }

        // Inicializar animaciones cuando la p√°gina carga
        document.addEventListener('DOMContentLoaded', function() {
            addChartAnimations();
        });

        // Funci√≥n para actualizar datos en tiempo real (simulado)
        setInterval(() => {
            // Simular peque√±os cambios en los datos cada 30 segundos
            if (Math.random() > 0.7) {
                const randomIndex = Math.floor(Math.random() * productionData.length);
                const variation = Math.floor(Math.random() * 200) - 100;
                productionData[randomIndex].production += variation;
                
                if (productionData[randomIndex].production < 0) {
                    productionData[randomIndex].production = Math.abs(variation);
                }
                
                // Solo actualizar si no hay filtros activos
                const yearFilter = document.getElementById('yearFilter').value;
                const fincaFilter = document.getElementById('fincaFilter').value;
                const tipoBananoFilter = document.getElementById('tipoBananoFilter').value;
                
                if (yearFilter === 'all' && fincaFilter === 'all' && tipoBananoFilter === 'all') {
                    // Mostrar notificaci√≥n de actualizaci√≥n autom√°tica
                    const Toast = Swal.mixin({
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    });

                    Toast.fire({
                        icon: 'info',
                        title: 'üîÑ Datos actualizados autom√°ticamente'
                    });
                    
                    updateDashboard();
                }
            }
        }, 30000);

        // Funci√≥n para mostrar tooltips informativos con SweetAlert
        function showTooltip(element, message, type = 'info') {
            Swal.fire({
                title: type === 'info' ? 'üí° Informaci√≥n' : 'üìä Detalle',
                text: message,
                icon: type,
                position: 'top',
                timer: 4000,
                timerProgressBar: true,
                toast: true,
                showConfirmButton: false,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });
        }

        // Agregar tooltips a elementos importantes con SweetAlert
        document.addEventListener('DOMContentLoaded', function() {
            const metricCards = document.querySelectorAll('.metric-card');
            metricCards.forEach((card, index) => {
                card.addEventListener('click', function() {
                    const messages = [
                        'Suma total de la producci√≥n en racimos para el per√≠odo seleccionado. Este valor representa el volumen total cosechado.',
                        'Rendimiento promedio por hect√°rea cultivada. Indica la eficiencia productiva de las fincas.',
                        'Porcentaje de la producci√≥n destinada a exportaci√≥n vs mercado nacional. Muestra el enfoque comercial.',
                        'N√∫mero de fincas con producci√≥n activa en el per√≠odo seleccionado.'
                    ];
                    
                    const titles = [
                        'üìä Producci√≥n Total',
                        'üåæ Rendimiento por Hect√°rea', 
                        'üì§ Porcentaje de Exportaci√≥n',
                        'üè¢ Fincas Activas'
                    ];
                    
                    Swal.fire({
                        title: titles[index],
                        text: messages[index],
                        icon: 'info',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#4CAF50',
                        showClass: {
                            popup: 'animate__animated animate__zoomIn'
                        }
                    });
                });
            });

            // Agregar informaci√≥n adicional a los gr√°ficos
            const chartCards = document.querySelectorAll('.card h3');
            chartCards.forEach(header => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', function() {
                    const chartType = this.textContent;
                    let message = '';
                    
                    switch(true) {
                        case chartType.includes('Mensual'):
                            message = 'Muestra la evoluci√≥n de la producci√≥n mes a mes. Permite identificar temporadas altas y bajas en la producci√≥n de banano.';
                            break;
                        case chartType.includes('A√±os'):
                            message = 'Compara la producci√≥n total entre diferentes a√±os para identificar tendencias de crecimiento en el cultivo de banano.';
                            break;
                        case chartType.includes('Fincas'):
                            message = 'Distribuci√≥n de la producci√≥n entre las diferentes fincas, mostrando su contribuci√≥n relativa a la producci√≥n total.';
                            break;
                        case chartType.includes('Tipo'):
                            message = 'Porcentaje de producci√≥n por tipo de banano (Dortio, Gros Michel, Cavendish), ayuda a entender la diversificaci√≥n de cultivos.';
                            break;
                        case chartType.includes('Exportaci√≥n'):
                            message = 'Proporci√≥n entre banano destinado a exportaci√≥n vs mercado nacional. Importante para an√°lisis de mercados.';
                            break;
                        case chartType.includes('Hect√°rea'):
                            message = 'Rendimiento por hect√°rea de cada combinaci√≥n finca-tipo de banano, indicador clave de eficiencia productiva.';
                            break;
                    }
                    
                    Swal.fire({
                        title: chartType,
                        text: message,
                        icon: 'question',
                        confirmButtonText: '¬°Entendido!',
                        confirmButtonColor: '#4CAF50'
                    });
                });
            });

            // Funcionalidad adicional: Confirmaci√≥n antes de cambiar filtros importantes
            const yearFilter = document.getElementById('yearFilter');
            
            yearFilter.addEventListener('change', function(e) {
                if (this.value !== 'all') {
                    Swal.fire({
                        title: 'üìÖ Filtrar por A√±o',
                        text: `¬øDeseas ver solo los datos del a√±o ${this.value}?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#4CAF50',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: 'S√≠, filtrar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            updateDashboard();
                            Swal.fire({
                                toast: true,
                                position: 'top-end',
                                icon: 'success',
                                title: `Mostrando datos de ${this.value}`,
                                showConfirmButton: false,
                                timer: 2000
                            });
                        } else {
                            this.value = 'all';
                        }
                    });
                } else {
                    updateDashboard();
                }
            });

            // Easter egg: Mensaje especial si se hace clic muchas veces en el t√≠tulo
            let titleClickCount = 0;
            const title = document.querySelector('.header h1');
            title.style.cursor = 'pointer';
            title.addEventListener('click', function() {
                titleClickCount++;
                if (titleClickCount === 5) {
                    Swal.fire({
                        title: 'üéâ ¬°Descubriste un Easter Egg!',
                        html: 
                            `<div style="text-align: center;">
                                <p>üçå ¬°Eres un verdadero experto en banano!</p>
                                <p>Has explorado cada rinc√≥n del dashboard</p>
                                <div style="font-size: 3rem; margin: 20px 0;">üèÜ</div>
                            </div>`,
                        confirmButtonText: '¬°Genial!',
                        confirmButtonColor: '#4CAF50',
                        showClass: {
                            popup: 'animate__animated animate__tada'
                        }
                    });
                    titleClickCount = 0;
                }
            });

            // Mostrar ayuda contextual
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F1' || (e.ctrlKey && e.key === 'h')) {
                    e.preventDefault();
                    showHelpModal();
                }
            });
        });

        // Funci√≥n para mostrar modal de ayuda
        function showHelpModal() {
            Swal.fire({
                title: '‚ùì Ayuda del Sistema de Banano',
                html: 
                    `<div style="text-align: left; max-height: 400px; overflow-y: auto;">
                        <h4>üìä C√≥mo usar el Dashboard:</h4>
                        <ul>
                            <li><strong>Filtros:</strong> Usa los selectores para filtrar por a√±o, finca o tipo de banano</li>
                            <li><strong>M√©tricas:</strong> Haz clic en las tarjetas de m√©tricas para m√°s informaci√≥n</li>
                            <li><strong>Gr√°ficos:</strong> Haz clic en los t√≠tulos de los gr√°ficos para entender qu√© muestran</li>
                            <li><strong>Exportar:</strong> Usa los botones de exportaci√≥n para generar reportes</li>
                        </ul>
                        
                        <h4>‚ö° Atajos de teclado:</h4>
                        <ul>
                            <li><strong>F1 o Ctrl+H:</strong> Mostrar esta ayuda</li>
                            <li><strong>Ctrl+P:</strong> Exportar a PDF</li>
                            <li><strong>Ctrl+E:</strong> Exportar a Excel</li>
                        </ul>
                        
                        <h4>üîÑ Actualizaci√≥n autom√°tica:</h4>
                        <p>Los datos se actualizan autom√°ticamente cada 30 segundos cuando no hay filtros activos.</p>
                        
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 15px;">
                            <small><strong>üí° Consejo:</strong> Haz clic en cualquier elemento del dashboard para obtener informaci√≥n adicional sobre producci√≥n de banano.</small>
                        </div>
                    </div>`,
                width: 600,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#4CAF50',
                showClass: {
                    popup: 'animate__animated animate__fadeInDown'
                }
            });
        }

        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                exportToPDF();
            } else if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportToExcel();
            }
        });

        // Notificaci√≥n de bienvenida con informaci√≥n sobre atajos
        window.addEventListener('load', function() {
            setTimeout(() => {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'bottom-end',
                    showConfirmButton: false,
                    timer: 6000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });

                Toast.fire({
                    icon: 'info',
                    title: 'üí° Consejo: Presiona F1 para ver la ayuda completa'
                });
            }, 3000);
        });

        // Funci√≥n para manejar errores globales
        window.addEventListener('error', function(e) {
            Swal.fire({
                icon: 'error',
                title: '‚ö†Ô∏è Error del Sistema',
                text: 'Ha ocurrido un error inesperado. Por favor, recarga la p√°gina.',
                footer: '<small>Si el problema persiste, contacta al administrador.</small>',
                confirmButtonText: 'Recargar p√°gina',
                confirmButtonColor: '#f5576c'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload();
                }
            });
        });
    </script>
</body>
</html>