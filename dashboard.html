<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Banano</title>
  <link rel="stylesheet" href="./css/dashboard.css" />
  <style>
    /* Estilos para el widget de clima */
    .weather-prediction-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }

    .weather-widget {
      flex: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 25px;
      color: white;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      min-height: 280px;
    }

    .weather-widget:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 50px rgba(102, 126, 234, 0.4);
    }

    .weather-widget::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    .weather-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }

    .weather-location {
      font-size: 16px;
      opacity: 0.9;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .weather-time {
      font-size: 14px;
      opacity: 0.8;
    }

    .weather-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      position: relative;
      z-index: 2;
    }

    .weather-temp {
      font-size: 48px;
      font-weight: 300;
      margin: 0;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .weather-icon {
      font-size: 64px;
      animation: bounce 2s infinite;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .weather-description {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 5px;
      position: relative;
      z-index: 2;
    }

    .weather-feels-like {
      font-size: 14px;
      opacity: 0.8;
      position: relative;
      z-index: 2;
    }

    .weather-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
      position: relative;
      z-index: 2;
    }

    .weather-detail-item {
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
    }

    .weather-detail-item:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.05);
    }

    .weather-detail-label {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 2px;
    }

    .weather-detail-value {
      font-size: 16px;
      font-weight: 600;
    }

    .prediction-widget {
      flex: 1;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      border-radius: 20px;
      padding: 25px;
      color: white;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(46, 204, 113, 0.3);
      transition: all 0.3s ease;
      min-height: 280px;
    }

    .prediction-widget:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 50px rgba(46, 204, 113, 0.4);
    }

    .prediction-widget::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: float 8s ease-in-out infinite reverse;
    }

    .prediction-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }

    .prediction-icon {
      font-size: 24px;
    }

    .prediction-title {
      font-size: 18px;
      font-weight: 600;
    }

    .prediction-yield {
      font-size: 36px;
      font-weight: 300;
      margin: 15px 0;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      position: relative;
      z-index: 2;
    }

    .prediction-date {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }

    .prediction-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      position: relative;
      z-index: 2;
    }

    .prediction-stat {
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      text-align: center;
      transition: all 0.3s ease;
    }

    .prediction-stat:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.05);
    }

    .prediction-stat-value {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .prediction-stat-label {
      font-size: 12px;
      opacity: 0.8;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .weather-prediction-container {
        flex-direction: column;
      }
      
      .weather-temp {
        font-size: 36px;
      }
      
      .weather-icon {
        font-size: 48px;
      }
      
      .prediction-yield {
        font-size: 28px;
      }
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="logo">üçå BananoSys</div>
      <span id="userNameDisplay" class="user-name">Cargando...</span>
      <ul>
        <li><a href="prediccion.html" class="menu-link">üåæ <span>Predicci√≥n</span></a></li>
        <li><a href="exportaciones.html" class="menu-link">üöö <span>Gesti√≥n de Exportaciones</span></a></li>
        <li><a href="inventario.html" class="menu-link">üßæ <span>Inventario y Postcosecha</span></a></li>
        <li><a href="Analisis.html" class="menu-link">üìà <span>An√°lisis Estad√≠stico de Producci√≥n</span></a></li>
        <li><a href="ControlPlagas.html" class="menu-link">üêõ <span>Control de Plagas y Calidad Pre-Exportaci√≥n</span></a></li>
        <li><a href="calendario.html" class="menu-link">üìÖ <span>Calendario Agr√≠cola</span></a></li>
        <li><a href="RecomendacionesIA.html" class="menu-link">üß† <span>Recomendaciones Inteligentes (IA)</span></a></li> 
        <li><a href="costo.html" class="menu-link">üíµ <span>Gesti√≥n de Costos y Rentabilidad</span></a></li>
        <li><button id="logoutBtn">üîí Cerrar sesi√≥n</button></li>
      </ul>
    </aside>
    <main>
      <header class="topbar"> 
        <h1>Panel de Control de Banano</h1>
      </header>
      <section id="contenido" class="content fade-in">
        <!-- Widget de Clima y Predicci√≥n -->
        <div class="weather-prediction-container">
          <!-- Widget de Clima -->
          <div class="weather-widget">
            <div class="weather-header">
              <div class="weather-location">
                üìç <span id="locationName">Milagro, Ecuador</span>
              </div>
              <div class="weather-time" id="currentTime">Cargando...</div>
            </div>
            
            <div class="weather-main">
              <div>
                <div class="weather-temp" id="temperature">
                  <span class="loading"></span>
                </div>
                <div class="weather-description" id="weatherDescription">Obteniendo clima...</div>
                <div class="weather-feels-like" id="feelsLike">Sensaci√≥n t√©rmica: --¬∞</div>
              </div>
              <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
            </div>
            
            <div class="weather-details">
              <div class="weather-detail-item">
                <div class="weather-detail-label">üí® Viento</div>
                <div class="weather-detail-value" id="windSpeed">-- km/h</div>
              </div>
              <div class="weather-detail-item">
                <div class="weather-detail-label">üíß Humedad</div>
                <div class="weather-detail-value" id="humidity">--%</div>
              </div>
              <div class="weather-detail-item">
                <div class="weather-detail-label">üëÅÔ∏è Visibilidad</div>
                <div class="weather-detail-value" id="visibility">-- km</div>
              </div>
              <div class="weather-detail-item">
                <div class="weather-detail-label">üåÖ UV</div>
                <div class="weather-detail-value" id="uvIndex">--</div>
              </div>
            </div>
          </div>

          <!-- Widget de Predicci√≥n actualizado -->
          <div class="prediction-widget">
            <div class="prediction-header">
              <span class="prediction-icon">üåæ</span>
              <span class="prediction-title">√öltima Predicci√≥n de Cosecha</span>
            </div>
            
            <div class="prediction-yield" id="predictionYield">-- ton/ha</div>
            <div class="prediction-date" id="predictionDate">Fecha: --</div>
            
            <div class="prediction-stats">
              <div class="prediction-stat">
                <div class="prediction-stat-value" id="expectedGrowth">+15%</div>
                <div class="prediction-stat-label">Crecimiento esperado</div>
              </div>
              <div class="prediction-stat">
                <div class="prediction-stat-value" id="qualityScore">85%</div>
                <div class="prediction-stat-label">Calidad estimada</div>
              </div>
              <div class="prediction-stat">
                <div class="prediction-stat-value" id="harvestDays">45</div>
                <div class="prediction-stat-label">D√≠as p/ cosecha</div>
              </div>
              <div class="prediction-stat">
                <div class="prediction-stat-value" id="riskLevel">Bajo</div>
                <div class="prediction-stat-label">Nivel de riesgo</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Gr√°fico de predicci√≥n existente -->
        <div class="grafico-prediccion">
          <div id="graficoPrediccion" style="height: 300px;"></div>
        </div>

        <!-- Nuevas m√©tricas de exportaciones -->
        <div class="export-stats">
          <div class="stat-card">
            <h3>üìä Total Pedidos</h3>
            <div class="number" id="totalPedidos">0</div>
          </div>
          <div class="stat-card pendiente">
            <h3>‚è≥ Pendientes</h3>
            <div class="number" id="pedidosPendientes">0</div>
          </div>
          <div class="stat-card proceso">
            <h3>üîÑ En Proceso</h3>
            <div class="number" id="pedidosProceso">0</div>
          </div>
          <div class="stat-card enviado">
            <h3>üöö Enviados</h3>
            <div class="number" id="pedidosEnviados">0</div>
          </div>
          <div class="stat-card entregado">
            <h3>‚úÖ Entregados</h3>
            <div class="number" id="pedidosEntregados">0</div>
          </div>
        </div>

        <!-- Gr√°ficos de exportaciones -->
        <div class="charts-container">
          <div class="chart-card">
            <div class="chart-title">üìà Estados de Pedidos</div>
            <div id="estadosChart" style="height: 300px;"></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">üåç Destinos Principales</div>
            <div id="destinosChart" style="height: 300px;"></div>
          </div>
        </div>

        <!-- Exportaciones recientes -->
        <div class="recent-exports">
          <h2>üöö Exportaciones Recientes</h2>
          <div id="recentExports">
            <p style="text-align: center; color: #7f8c8d; padding: 20px;">No hay exportaciones registradas</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
  <!-- Firebase scripts -->
  <script type="module" src="./firebase.js"></script>
  <script type="module">
    import { auth } from './firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logoutBtn');
      const userNameDisplay = document.getElementById('userNameDisplay');

      // Funci√≥n para obtener el clima
      async function getWeatherData() {
        try {
          // Simulamos datos del clima para Ecuador (puedes usar una API real como OpenWeatherMap)
          const weatherData = {
            temperature: Math.round(25 + Math.random() * 10), // 25-35¬∞C t√≠pico en Ecuador
            feelsLike: Math.round(27 + Math.random() * 8),
            description: ['Soleado', 'Parcialmente nublado', 'Nublado', 'Lluvia ligera'][Math.floor(Math.random() * 4)],
            humidity: Math.round(60 + Math.random() * 30), // 60-90%
            windSpeed: Math.round(5 + Math.random() * 15), // 5-20 km/h
            visibility: Math.round(8 + Math.random() * 7), // 8-15 km
            uvIndex: Math.round(6 + Math.random() * 5) // 6-11
          };

          // Iconos seg√∫n el clima
          const weatherIcons = {
            'Soleado': '‚òÄÔ∏è',
            'Parcialmente nublado': '‚õÖ',
            'Nublado': '‚òÅÔ∏è',
            'Lluvia ligera': 'üå¶Ô∏è'
          };

          // Actualizar UI
          document.getElementById('temperature').textContent = `${weatherData.temperature}¬∞`;
          document.getElementById('weatherDescription').textContent = weatherData.description;
          document.getElementById('feelsLike').textContent = `Sensaci√≥n t√©rmica: ${weatherData.feelsLike}¬∞`;
          document.getElementById('weatherIcon').textContent = weatherIcons[weatherData.description] || 'üå§Ô∏è';
          document.getElementById('windSpeed').textContent = `${weatherData.windSpeed} km/h`;
          document.getElementById('humidity').textContent = `${weatherData.humidity}%`;
          document.getElementById('visibility').textContent = `${weatherData.visibility} km`;
          document.getElementById('uvIndex').textContent = weatherData.uvIndex;

        } catch (error) {
          console.error('Error al obtener datos del clima:', error);
          document.getElementById('temperature').textContent = '25¬∞';
          document.getElementById('weatherDescription').textContent = 'Clima no disponible';
        }
      }

      // Funci√≥n para actualizar la hora
      function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-EC', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
        });
        document.getElementById('currentTime').textContent = timeString;
      }

      // Actualizar clima y hora
      getWeatherData();
      updateTime();
      setInterval(updateTime, 60000); // Actualizar cada minuto
      setInterval(getWeatherData, 600000); // Actualizar clima cada 10 minutos

      onAuthStateChanged(auth, (user) => {
        if (user) {
          const displayName = user.displayName || user.email;
          userNameDisplay.textContent = `üë§ ${displayName}`;
        } else {
          window.location.href = 'login.html';
        }
      });

      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          Swal.fire({
            title: '¬øEst√° seguro?',
            text: '¬øDesea cerrar sesi√≥n?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'S√≠, cerrar sesi√≥n',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              signOut(auth).then(() => {
                window.location.href = 'login.html';
              });
            }
          });
        });
      }

      // Mostrar √∫ltima predicci√≥n
      const prediccion = localStorage.getItem("ultimaPrediccion");
      if (prediccion) {
        const datos = JSON.parse(prediccion);
        
        // Actualizar widget de predicci√≥n
        document.getElementById('predictionYield').textContent = `${datos.rendimiento} ton/ha`;
        document.getElementById('predictionDate').textContent = `Fecha: ${datos.fecha}`;
        
        // Datos simulados adicionales
        document.getElementById('expectedGrowth').textContent = `+${Math.round(10 + Math.random() * 20)}%`;
        document.getElementById('qualityScore').textContent = `${Math.round(80 + Math.random() * 15)}%`;
        document.getElementById('harvestDays').textContent = Math.round(30 + Math.random() * 30);
        document.getElementById('riskLevel').textContent = ['Bajo', 'Medio', 'Alto'][Math.floor(Math.random() * 3)];

        // Mostrar gr√°fico de predicci√≥n
        var myChart = echarts.init(document.getElementById('graficoPrediccion'));
        var option = {
          title: {
            text: 'Predicci√≥n de Cosecha (Toneladas por Hect√°rea)',
            left: 'center',
            textStyle: {
              color: '#2980b9',
              fontSize: 16
            }
          },
          xAxis: {
            type: 'category',
            data: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
            axisLabel: {
              color: '#7f8c8d'
            }
          },
          yAxis: {
            type: 'value',
            name: 'Toneladas por Hect√°rea',
            axisLabel: {
              color: '#7f8c8d'
            }
          },
          series: [{
            data: [
              datos.rendimiento * 0.6,
              datos.rendimiento * 0.8,
              datos.rendimiento * 0.9,
              parseFloat(datos.rendimiento)
            ],
            type: 'line',
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                {offset: 0, color: '#2ecc71'},
                {offset: 1, color: '#27ae60'}
              ])
            },
            lineStyle: {
              color: '#2ecc71',
              width: 3
            },
            itemStyle: {
              color: '#2ecc71'
            },
            animationDuration: 2000,
            animationEasing: 'bounceOut'
          }]
        };
        myChart.setOption(option);
      } else {
        // Datos por defecto si no hay predicci√≥n
        document.getElementById('predictionYield').textContent = '-- ton/ha';
        document.getElementById('predictionDate').textContent = 'Fecha: No disponible';
      }

      // ===== FUNCIONALIDAD DE EXPORTACIONES =====
      
      // Cargar datos de exportaciones
      function loadExportData() {
        const savedOrders = localStorage.getItem('exportOrders');
        if (savedOrders) {
          try {
            return JSON.parse(savedOrders);
          } catch (error) {
            console.error('Error al cargar datos de exportaciones:', error);
            return [];
          }
        }
        return [];
      }

      // Actualizar m√©tricas de exportaciones
      function updateExportMetrics() {
        const orders = loadExportData();
        
        const stats = {
          total: orders.length,
          pendiente: orders.filter(o => o.estado === 'pendiente').length,
          proceso: orders.filter(o => o.estado === 'proceso').length,
          enviado: orders.filter(o => o.estado === 'enviado').length,
          entregado: orders.filter(o => o.estado === 'entregado').length
        };

        // Actualizar n√∫meros en las tarjetas
        document.getElementById('totalPedidos').textContent = stats.total;
        document.getElementById('pedidosPendientes').textContent = stats.pendiente;
        document.getElementById('pedidosProceso').textContent = stats.proceso;
        document.getElementById('pedidosEnviados').textContent = stats.enviado;
        document.getElementById('pedidosEntregados').textContent = stats.entregado;

        // Crear gr√°fico de estados
        createStatesChart(stats);
        
        // Crear gr√°fico de destinos
        createDestinationsChart(orders);
        
        // Mostrar exportaciones recientes
        showRecentExports(orders);
      }

      // Crear gr√°fico de estados
      function createStatesChart(stats) {
        const chart = echarts.init(document.getElementById('estadosChart'));
        const option = {
          tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b}: {c} ({d}%)'
          },
          series: [{
            name: 'Estados',
            type: 'pie',
            radius: '70%',
            data: [
              {value: stats.pendiente, name: 'Pendientes', itemStyle: {color: '#f39c12'}},
              {value: stats.proceso, name: 'En Proceso', itemStyle: {color: '#3498db'}},
              {value: stats.enviado, name: 'Enviados', itemStyle: {color: '#9b59b6'}},
              {value: stats.entregado, name: 'Entregados', itemStyle: {color: '#27ae60'}}
            ],
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            }
          }]
        };
        chart.setOption(option);
      }

      // Crear gr√°fico de destinos
      function createDestinationsChart(orders) {
        const destinations = {};
        orders.forEach(order => {
          destinations[order.paisDestino] = (destinations[order.paisDestino] || 0) + 1;
        });

        const sortedDestinations = Object.entries(destinations)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 6);

        const chart = echarts.init(document.getElementById('destinosChart'));
        const option = {
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'shadow'
            }
          },
          xAxis: {
            type: 'category',
            data: sortedDestinations.map(([pais]) => pais),
            axisLabel: {
              interval: 0,
              rotate: 45,
              color: '#7f8c8d'
            }
          },
          yAxis: {
            type: 'value',
            axisLabel: {
              color: '#7f8c8d'
            }
          },
          series: [{
            data: sortedDestinations.map(([, cantidad]) => cantidad),
            type: 'bar',
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                {offset: 0, color: '#667eea'},
                {offset: 1, color: '#764ba2'}
              ])
            }
          }]
        };
        chart.setOption(option);
      }

      // Mostrar exportaciones recientes
      function showRecentExports(orders) {
        const recentOrders = orders
          .sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion))
          .slice(0, 5);

        const container = document.getElementById('recentExports');
        
        if (recentOrders.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No hay exportaciones registradas</p>';
          return;
        }

        const html = recentOrders.map(order => `
          <div class="export-item">
            <div class="export-info">
              <div class="export-id">${order.id}</div>
              <div class="export-details">
                ${order.cliente} ‚Ä¢ ${order.paisDestino} ‚Ä¢ ${order.variedad} ‚Ä¢ ${order.cantidad.toLocaleString()} unidades
              </div>
            </div>
            <div class="status-badge status-${order.estado}">
              ${order.estado.toUpperCase()}
            </div>
          </div>
        `).join('');

        container.innerHTML = html;
      }

      // Inicializar datos de exportaciones
      updateExportMetrics();

      // Actualizar cada 30 segundos por si hay cambios
      setInterval(updateExportMetrics, 30000);
    });
  </script>
</body>
</html>